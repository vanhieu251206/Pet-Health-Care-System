{% extends "pets/base.html" %}
{% load static %}

{% block thanh_toan %}
<style>
  /* Container ch√≠nh c·ªßa trang thanh to√°n */
  .checkout-container {
    background-color: #ffffff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  /* Ti√™u ƒë·ªÅ ph·∫ßn thanh to√°n */
  .checkout-header {
    background-color: #198754;
    color: white;
    padding: 15px;
    border-radius: 5px;
    font-size: 1.4rem;
    font-weight: bold;
    text-align: center;
  }

  /* B·∫£ng s·∫£n ph·∫©m */
  .table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .table th {
    background-color: #f8f9fa;
    text-align: center;
    vertical-align: middle;
    padding: 12px;
    font-weight: bold;
    font-size: 1rem;
  }

  .table td {
    vertical-align: middle;
    text-align: center;
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
  }

  /* C·ªôt s·∫£n ph·∫©m v·ªõi ·∫£nh */
  .cart-img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
  }

  .total-price {
    font-size: 1.3rem;
    font-weight: bold;
    color: #198754;
  }

  /* N√∫t thanh to√°n */
  .checkout-btn {
    background-color: #198754;
    color: white;
    font-size: 1.1rem;
    font-weight: bold;
    border-radius: 5px;
    padding: 10px 20px;
    display: block;
    text-align: center;
    width: fit-content;
    margin: 20px auto;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }

  .checkout-btn:hover {
    background-color: #146c43;
  }

  .form-control {
    border-radius: 5px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .btn-remove {
    background-color: #dc3545;
    color: white;
    border-radius: 5px;
    padding: 5px 10px;
    text-decoration: none;
    font-size: 14px;
  }

  .btn-remove:hover {
    background-color: #b02a37;
  }

  .text-end {
    text-align: right;
  }

  /* ƒê·ªãnh d·∫°ng khung ƒë·ªãa ch·ªâ */
  .address-box {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    font-size: 1rem;
    color: #333;
    position: relative;
  }

  .address-box h6 {
    font-size: 1.3rem;
    font-weight: bold;
  }

  .edit-address-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 1.5rem;
    color: #198754;
    cursor: pointer;
  }

  .edit-address-icon:hover {
    color: #146c43;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 1050;
    width: 90%;
    max-width: 600px;
  }

  .modal.show {
    display: block;
  }

  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
  }

  .modal-content {
    padding: 20px;
  }

  .btn-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #dc3545;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
  }

  .btn-close:hover {
    background-color: #b02a37;
  }

  .modal form input,
  .modal form textarea,
  .modal form select {
    margin-bottom: 10px;
    
  }

  #payment-btn {
    background-color: #198754;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    padding: 12px 24px;
    display: block; /* Gi√∫p cƒÉn gi·ªØa v·ªõi margin auto */
    width: fit-content; /* ƒê·ªãnh k√≠ch th∆∞·ªõc theo n·ªôi dung */
    margin: 20px auto; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
    text-decoration: none;
    transition: background-color 0.3s ease;
    cursor: pointer;
  }
  
  #payment-btn:hover {
    background-color: #146c43;
  }

  .payment-container {
    display: flex;
    justify-content: center; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
    align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    margin-top: 20px;
  }
  
  

</style>

<div class="container mt-4 checkout-container">
  <div class="checkout-header">üõí Thanh to√°n ƒë∆°n h√†ng</div>
  
  {% if address %}
    <!-- Hi·ªÉn th·ªã ƒë·ªãa ch·ªâ c·ªßa kh√°ch h√†ng n·∫øu c√≥ -->
    <div class="address-box">
      <h6>ƒê·ªãa ch·ªâ giao h√†ng</h6>
      <p><strong>{{ address.full_name }} </strong>{{ address.phone }}</p>
      <p>{{ address.street_address }}</p>
      <p>{{ address.district }}, {{ address.city }}, {{ address.province }}</p>
     
      <!-- N√∫t s·ª≠a ƒë·ªãa ch·ªâ -->
      <span class="edit-address-icon" onclick="showModal()">‚úèÔ∏è</span>
    </div>
  {% else %}
    <!-- N√∫t th√™m ƒë·ªãa ch·ªâ n·∫øu ch∆∞a c√≥ ƒë·ªãa ch·ªâ -->
    <button class="checkout-btn" onclick="showModal()">Th√™m ƒë·ªãa ch·ªâ giao h√†ng</button>
  {% endif %}

  <!-- B·∫£ng gi·ªè h√†ng -->
  <table class="table mt-3">
    <thead>
      <tr>
        <th style="width: 35%;">S·∫£n ph·∫©m</th>
        <th style="width: 20%;">ƒê∆°n gi√°</th>
        <th style="width: 20%;">S·ªë l∆∞·ª£ng</th>
        <th style="width: 20%;">Th√†nh ti·ªÅn</th>
      </tr>
    </thead>
    <tbody>
      {% for item in cart_items %}
      <tr>
        <td class="d-flex align-items-center product-name">
          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="cart-img me-3">
          <div>
            <h6 class="my-0">{{ item.product.name }}</h6>
          </div>
        </td>
        <td>{{ item.product.price }} VND</td>
        <td>{{ item.quantity }}</td>
        <td class="total-price">{{ item.total_price }} VND</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" class="text-end fw-bold">T·ªîNG THANH TO√ÅN (VNƒê)</td>
        <td class="total-price">{{ total_price }} VND</td>
      </tr>
    </tfoot>
  </table>

  <!-- Modal Th√™m/S·ª≠a ƒë·ªãa ch·ªâ -->
  <div class="modal" id="addressModal">
    <div class="modal-content">
      <span class="btn-close" onclick="closeModal()">X</span>
      <h4>Th√™m/S·ª≠a ƒë·ªãa ch·ªâ</h4>
      <form id="addressForm">
        {% csrf_token %}
        <div class="form-group">
          <label>H·ªç v√† t√™n</label>
          <input type="text" class="form-control" name="full_name" value="{{ address.full_name }}" required>
        </div>
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="text" class="form-control" name="phone" value="{{ address.phone }}" required>
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ</label>
          <input type="text" class="form-control" name="street_address" value="{{ address.street_address }}" required>
        </div>
        <div class="form-group">
          <label>X√£/Ph∆∞·ªùng</label>
          <input type="text" class="form-control" name="district" value="{{ address.district }}" required>
        </div>
        <div class="form-group">
          <label>Qu·∫≠n/Huy·ªán</label>
          <input type="text" class="form-control" name="city" value="{{ address.city }}" required>
        </div>
        <div class="form-group">
          <label>T·ªânh/Th√†nh Ph·ªë</label>
          <input type="text" class="form-control" name="province" value="{{ address.province }}" required>
        </div>
        <button type="submit" class="btn btn-success">L∆∞u ƒë·ªãa ch·ªâ</button>
      </form>
    </div>
  </div>

  <div class="payment-container">
    <button id="payment-btn">Thanh to√°n</button>
  </div>

</div>

<script>
  // Hi·ªÉn th·ªã modal
  function showModal() {
    document.getElementById('addressModal').classList.add('show');
    document.querySelector('.modal-backdrop').classList.add('show');
  }

  // ƒê√≥ng modal
  function closeModal() {
    document.getElementById('addressModal').classList.remove('show');
    document.querySelector('.modal-backdrop').classList.remove('show');
  }

  // G·ª≠i d·ªØ li·ªáu ƒë·ªãa ch·ªâ qua AJAX
  document.getElementById("addressForm").addEventListener("submit", function(event) {
    event.preventDefault();

    var formData = new FormData(this);
    
    fetch("{% url 'pets:add_address' %}", {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        alert(data.message);
        location.reload();  // L√†m m·ªõi trang ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªãa ch·ªâ m·ªõi
        closeModal();
      } else {
        alert('ƒê√£ c√≥ l·ªói x·∫£y ra!');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ƒê√£ c√≥ l·ªói x·∫£y ra!');
    });
  });
  document.getElementById("addressForm").addEventListener("submit", function(event) {
    event.preventDefault();  // Ng·ª´ng h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa form
  
    var formData = new FormData(this);  // L·∫•y d·ªØ li·ªáu t·ª´ form
    
    fetch("{% url 'pets:add_address' %}", {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())  // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu nh·∫≠n v·ªÅ th√†nh JSON
    .then(data => {
      if (data.status === 'success') {
        alert(data.message);  // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        location.reload();  // L√†m m·ªõi trang ƒë·ªÉ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ m·ªõi
        closeModal();  // ƒê√≥ng modal sau khi l∆∞u ƒë·ªãa ch·ªâ
      } else {
        alert('ƒê√£ c√≥ l·ªói x·∫£y ra!');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('ƒê√£ c√≥ l·ªói x·∫£y ra!');
    });
  });
</script>

{% endblock thanh_toan %}
